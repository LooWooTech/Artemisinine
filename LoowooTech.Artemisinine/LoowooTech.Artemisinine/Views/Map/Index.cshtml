@{
    ViewBag.Title = "地图";
    Layout = "~/Views/Map/_Layout.cshtml";
}

<style>
     html,body,#map{
        height: 100%; width: 100%; margin: 0; padding: 0; 
    }
      #search {
         display: block;
         position: absolute;
         z-index: 2;
         top: 20px;
         left: 74px;
      }
       #menu{
         position:absolute;
         z-index:2;
         top:20px;
         left:74px;
     }
       #bottomPanel{
           left:50%;
           margin:0 auto;
           margin-left:-500px;
           position:absolute;
           bottom:2.5em;
       }
       #timeInfo{
           border-radius:4px;
           border:solid 2px #ccc;
           background-color:#fff;
           display:block;
           padding:5px;
           position:relative;
           text-align:center;
           width:1000px;
           z-index:99;
       }
</style>

<script>
    require([
        "esri/map","esri/layers/FeatureLayer","esri/dijit/Search","esri/InfoTemplate",
        "esri/layers/ArcGISTiledMapServiceLayer",
        "esri/dijit/InfoWindowLite", "dojo/dom-construct",
        "esri/dijit/TimeSlider","esri/TimeExtent","dojo/dom",
        "dojo/domReady!"
    ], function (
        Map,FeatureLayer,Search,InfoTemplate,
        Tiled,
        InfoWindowLite,domConstruct,
        TimeSlider,TimeExtent,dom
        ) {
        var map = new Map("map", {
            logo:false
        });
        var tiled = new Tiled("http://127.0.0.1:6080/arcgis/rest/services/NN/MapServer");
        map.addLayer(tiled);

        var infoWindow = new InfoWindowLite(null, domConstruct.create("div", null, null, map.root));
        infoWindow.startup();
        map.setInfoWindow(infoWindow);
        var template = new InfoTemplate();
        template.setTitle("<b>${JGID}-${NAME}<b/>");
        template.setContent("机构ID：${JGID} <br/> 医疗名称：${NAME}");

        var featureLayer = new FeatureLayer("http://127.0.0.1:6080/arcgis/rest/services/NN/MapServer/1", {
            mode: FeatureLayer.MODE_ONDEMAND,
            infoTemplate: template,
            outFields: ["JGID", "NAME"]
        });

        map.addLayer(featureLayer);

        map.infoWindow.resize(300, 100);

        var s = new Search({
            sources: [{
                featureLayer: new FeatureLayer("http://127.0.0.1:6080/arcgis/rest/services/NN/MapServer/1", {
                    outFields: ["*"],
                    infoTemplate: new InfoTemplate("医疗机构", "医疗机构ID：${JGID}<br/> 机构名称：${NAME}<br/>")
                }),
                searchFields: ["NAME"],
                outFields: ["JGID", "NAME"],
                displayField: "JGID",
                exactMatch: false,
                suggestionTemplate: "${JGID}",
                name: "医疗机构",
                enableSuggestions: true
            }],
            enableButtonMode: true,
            enableLabel: false,
            enableInfoWindow: true,
            showInfoWindowOnSelect: false,
            map: map
        }, "search");
        s.startup();

        map.on("layers-add-result", initSlider);
        function initSlider() {
            var timeSlider = new TimeSlider({
                style: "width:100%;"
            }, dom.byId("timeSliderDiv"));
            map.setTimeSlider(timeSlider);

            var timeExtent = new TimeExtent();
            timeExtent.startTime = new Date("1/1/1921 UTC");
            timeExtent.endTime = new Date("12/31/2009 UTC");
            timeSlider.setThumbCount(2);
            timeSlider.createTimeStopsByTimeInterval(timeExtent, 2, "esriTimeUnitsYears");
            timeSlider.setThumbIndexes([0, 1]);
            timeSlider.setThumbMovingRate(20000);
            //var myTimeStepIntervals = [new Date("01/01/1970"), new Date("01/01/1971"), new Date("01/01/1972"), new Date("01/01/1973"), new Date("01/01/1974")];
            //timeSlider.setTimeStops(myTimeStepIntervals);

            //timeSlider.setThumbCount(1);
            //timeSlider.createTimeStopsByTimeInterval(results[1].layer.timeInfo.timeExtent, 1, "esriTimeUnitsWeeks");
            timeSlider.startup();
        }
    })
</script>
<div id="search"></div>
<div class="row">
    <div id="menu" class="col-lg-8 col-lg-offset-2">
        <nav class="navbar navbar-inverse">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapse" data-toggle="collapse" data-target="#navbar-menu" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/Home/Index">疾病大数据</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-menu">
                    <ul class="nav navbar-nav">
                        <li><a href="#">地图<span class="sr-only">(current)</span></a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">地图控制<span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="" id="">卫星影像</a></li>
                                <li><a href="" id="">医疗机构</a></li>
                                <li><a href="" id=""></a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">疾病数据<span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="#">2015</a></li>
                                <li><a href="#">2015</a></li>
                                <li><a href="#">2015</a></li>
                                <li><a href="javascript:void(0)" id="TTime">疾病演变</a></li>
                            </ul>
                        </li>
                        <li><a href="#">Link</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </div>
</div>
<div id="map">
    <div id="bottomPanel">
        <div id="timeInfo">
            <div id="timeSliderDiv"></div>
        </div>
    </div>
    
</div>
